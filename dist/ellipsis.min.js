/*! Ellipsis - v0.1.0 - 2013-03-07
* https://github.com/wilsonpage/ellipsis
* Copyright (c) 2013 Wilson Page; Licensed MIT */
"use strict";(function(){function o(e,t){if(!e)return;this.el=e,this.container=t&&t.container,this.reRender=t&&t.reRender}function u(e){e.style.display="none";var t=e.offsetTop;e.style.display=""}function a(t,n){if(!t)return;var r=n&&n.display,i=t.parentNode.children,s=e.call(i,t);for(var o=s+1,u=i.length;o<u;o++)i[o].style.display=r}function f(e,t){var n=e.getClientRects(),r=0;return m(n,function(e){r+=l(e.height,t)}),r}function l(e,t){return Math.floor(e/t)}function c(){var e=document.createElement("div"),t=["Webkit","Moz","O","ms"],n=["-webkit-","-moz-","-o-","-ms-"];for(var r=0;r<t.length;r++)if(t[r]+"ColumnCount"in e.style)return{css:n[r],js:t[r],webkit:t[r]==="Webkit",moz:t[r]==="Moz"}}function h(e){return parseInt(e[s.js+"ColumnCount"],10)||1}function p(e){return parseInt(e[s.js+"ColumnGap"],10)}function d(e){var t=parseInt(e.lineHeight,10);if(!t)throw new Error(i[0]);return t}function v(e){return[e.offsetWidth,e.offsetHeight]}function m(e,t){for(var n=0,r=e.length;n<r;n++)if(t(e[n]))break}var e=Array.prototype.indexOf,t=window.getComputedStyle,n="ellipsis-overflowing-child",r="ellipsis-set",i=["The ellipsis container must have line-height set on it"],s=c();o.prototype.calc=function(){if(!this.el)return this;var e=t(this.el),n=v(this.el);return this.columnHeight=n[1],this.columnCount=h(e),this.columnGap=p(e),this.columnWidth=n[0]/this.columnCount,this.lineHeight=d(e),this.deltaHeight=n[1]%this.lineHeight,this.linesPerColumn=Math.floor(this.columnHeight/this.lineHeight),this.totalLines=this.linesPerColumn*this.columnCount,this.child=this.getOverflowingChild(),this},o.prototype.set=function(){return!this.el||!this.child?this:(this.clampChild(),a(this.child.el,{display:"none"}),this.markContainer(),this)},o.prototype.unset=function(){return!this.el||!this.child?this:(this.unclampChild(this.child),a(this.child.el,{display:""}),this.unmarkContainer(),this.child=null,this)},o.prototype.destroy=function(){return this.el=this.child=null,this},o.prototype.getOverflowingChild=function(){var e=this,t={},n=0;return m(this.el.children,function(r){var i,s,o,u=Math.floor(n/e.linesPerColumn);n+=i=e.getLineCount(r);if(n>=e.totalLines)return s=n-e.totalLines,o=i-s,t.el=r,t.clampedLines=o,t.clampedHeight=t.clampedLines*e.lineHeight,t.visibleColumnSpan=e.columnCount-u,t.applyTopMargin=e.shouldApplyTopMargin(t),t}),t},o.prototype.getLineCount=function(e){return e.offsetWidth>this.columnWidth?f(e,this.lineHeight):l(e.clientHeight,this.lineHeight)},o.prototype.markContainer=function(){if(!this.container)return;this.container.classList.add(r),this.reRender&&u(this.container)},o.prototype.unmarkContainer=function(){if(!this.container)return;this.container.classList.remove(r),this.reRender&&u(this.container)},o.prototype.shouldApplyTopMargin=function(e){var t=e.el;if(!s.webkit)return;if(this.columnCount===1)return;if(this.deltaHeight<=3)return;if(!t.previousElementSibling)return;return t.offsetTop===0||t.offsetTop===this.columnHeight},o.prototype.clampChild=function(){var e=this.child;if(!e||!e.el)return;e.el.style.height=e.clampedHeight+"px",s.webkit&&(e.el.style.webkitLineClamp=e.clampedLines,e.el.style.display="-webkit-box",e.el.style.webkitBoxOrient="vertical"),this.columnCount===1&&(e.el.style.overflow="hidden"),e.applyTopMargin&&(e.el.style.marginTop="2em"),e.el.classList.add(n),s.webkit||(e.helper=e.el.appendChild(this.helperElement()))},o.prototype.unclampChild=function(e){if(!e||!e.el)return;e.el.style.display="",e.el.style.height="",e.el.style.webkitLineClamp="",e.el.style.webkitBoxOrient="",e.el.style.marginTop="",e.el.style.overflow="",e.el.classList.remove(n),e.helper&&e.helper.parentNode.removeChild(e.helper)},o.prototype.helperElement=function(){var e=document.createElement("span"),t=this.child.visibleColumnSpan-1,n,r;return e.className="ellipsis-helper",e.style.display="block",e.style.height=this.lineHeight+"px",e.style.position="absolute",e.style.bottom=0,e.style.right=0,s.js==="Moz"&&t&&(n=t*100,r=-(t*this.columnGap),e.style.right="-"+n+"%",e.style.marginRight=r+"px",e.style.marginBottom=this.deltaHeight+"px"),e},typeof exports=="object"?(module.exports=function(e,t){return new o(e,t)},module.exports.Ellipsis=o):typeof define=="function"&&define.amd?define(o):window.Ellipsis=o})();